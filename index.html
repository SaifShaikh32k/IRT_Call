<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Picker Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 0;
      overflow-x: hidden;
    }

    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 22px;
      color: #5a2dbd;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .scan-section {
      padding: 20px 16px;
    }

    .input-group {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .input-group:active {
      transform: scale(0.98);
    }

    .input-label {
      font-size: 12px;
      font-weight: 600;
      color: #764ba2;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: block;
    }

    .input-field {
      width: 100%;
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      font-size: 16px;
      transition: all 0.3s;
      background: #f8f9fa;
    }

    .input-field:focus {
      outline: none;
      border-color: #764ba2;
      background: white;
      box-shadow: 0 0 0 4px rgba(118, 75, 162, 0.1);
    }

    .input-field::placeholder {
      color: #aaa;
    }

    .success-msg {
      position: fixed;
      top: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(-100px);
      background: #10b981;
      color: white;
      padding: 16px 32px;
      border-radius: 50px;
      font-weight: 600;
      box-shadow: 0 8px 32px rgba(16, 185, 129, 0.4);
      opacity: 0;
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
      z-index: 1000;
      pointer-events: none;
    }

    .success-msg.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .stats-bar {
      display: flex;
      gap: 12px;
      padding: 0 16px 20px;
    }

    .stat-card {
      flex: 1;
      background: white;
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #764ba2;
    }

    .stat-label {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .history-section {
      background: white;
      border-radius: 24px 24px 0 0;
      min-height: 300px;
      padding: 24px 16px;
      box-shadow: 0 -4px 24px rgba(0,0,0,0.1);
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .record-card {
      background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
      border-left: 4px solid #764ba2;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .record-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .record-time {
      font-size: 13px;
      font-weight: 600;
      color: #764ba2;
    }

    .record-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      background: #10b981;
      color: white;
    }

    .record-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .record-item {
      font-size: 13px;
    }

    .record-item-label {
      color: #666;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .record-item-value {
      color: #333;
      font-weight: 600;
      margin-top: 2px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 14px;
    }

    .loading::after {
      content: '';
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #764ba2;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-left: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    /* Haptic feedback simulation */
    .input-field:focus,
    .record-card:active {
      animation: haptic 0.1s;
    }

    @keyframes haptic {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(0.98); }
    }
  </style>
</head>

<body>

<div class="header">
  <h1>
    <span>üì¶</span>
    Picker Tracker
  </h1>
</div>

<div class="scan-section">
  <div class="input-group">
    <label class="input-label">üë§ User ID</label>
    <input id="userId" class="input-field" placeholder="Enter your User ID" inputmode="text">
  </div>

  <div class="input-group">
    <label class="input-label">üîñ WID</label>
    <input id="wid" class="input-field" placeholder="Scan or enter WID" inputmode="text">
  </div>

  <div class="input-group">
    <label class="input-label">üìç Location</label>
    <input id="location" class="input-field" placeholder="Scan location code" inputmode="text">
  </div>
</div>

<div class="stats-bar">
  <div class="stat-card">
    <div class="stat-number" id="todayCount">0</div>
    <div class="stat-label">Today</div>
  </div>
  <div class="stat-card">
    <div class="stat-number" id="totalCount">0</div>
    <div class="stat-label">Total</div>
  </div>
</div>

<div class="history-section">
  <div class="section-title">
    <span>üìã</span>
    Recent Activity
  </div>
  <div id="history"></div>
</div>

<div class="success-msg" id="msg">‚úÖ Saved Successfully</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby1RamE6nGqYFVjTKk9posAQV8JWyX0JCygwrIWu9Ycxqwq96q8WaYVVHxWNCEYp8G-LQ/exec";

const userIdEl = document.getElementById("userId");
const widEl = document.getElementById("wid");
const locationEl = document.getElementById("location");
const historyEl = document.getElementById("history");
const msgEl = document.getElementById("msg");
const todayCountEl = document.getElementById("todayCount");
const totalCountEl = document.getElementById("totalCount");

let cachedData = [];

// Load saved data
window.onload = () => {
  const savedUserId = localStorage.getItem("userId");
  const savedWid = localStorage.getItem("wid");
  
  if (savedUserId) {
    userIdEl.value = savedUserId;
    loadHistory();
  }
  if (savedWid) widEl.value = savedWid;
};

// Auto-save User ID & WID
userIdEl.addEventListener("input", debounce(() => {
  localStorage.setItem("userId", userIdEl.value.trim());
  if (userIdEl.value.trim()) loadHistory();
}, 500));

widEl.addEventListener("input", debounce(() => {
  localStorage.setItem("wid", widEl.value.trim());
}, 500));

// Submit on Enter
locationEl.addEventListener("keydown", e => {
  if (e.key === "Enter") {
    e.preventDefault();
    submitData();
  }
});

async function submitData() {
  const userId = userIdEl.value.trim();
  const wid = widEl.value.trim();
  const location = locationEl.value.trim();

  if (!userId || !wid || !location) {
    showToast("‚ö†Ô∏è All fields required", "#f59e0b");
    return;
  }

  try {
    const fd = new FormData();
    fd.append("userId", userId);
    fd.append("wid", wid);
    fd.append("location", location);

    await fetch(SCRIPT_URL, { method: "POST", body: fd });

    showToast("‚úÖ Saved Successfully", "#10b981");
    
    locationEl.value = "";
    locationEl.focus();

    // Optimistically add to cache
    const now = new Date();
    const timestamp = now.toLocaleString();
    cachedData.unshift([timestamp, userId, wid, location, "", "Active", ""]);
    renderHistory();
    
    // Reload from server
    setTimeout(() => loadHistory(), 1000);
  } catch (err) {
    showToast("‚ùå Error saving", "#ef4444");
  }
}

async function loadHistory() {
  const userId = userIdEl.value.trim();
  if (!userId) return;

  historyEl.innerHTML = '<div class="loading">Loading</div>';

  try {
    const res = await fetch(`${SCRIPT_URL}?userId=${encodeURIComponent(userId)}`);
    cachedData = await res.json();
    renderHistory();
  } catch (err) {
    historyEl.innerHTML = '<div class="empty-state">‚ö†Ô∏è Error loading data</div>';
  }
}

function renderHistory() {
  if (cachedData.length === 0) {
    historyEl.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì≠</div>
        <div>No records yet</div>
      </div>
    `;
    todayCountEl.textContent = "0";
    totalCountEl.textContent = "0";
    return;
  }

  const today = new Date().toDateString();
  const todayRecords = cachedData.filter(row => {
    const recordDate = new Date(row[0]).toDateString();
    return recordDate === today;
  });

  todayCountEl.textContent = todayRecords.length;
  totalCountEl.textContent = cachedData.length;

  historyEl.innerHTML = cachedData.slice(0, 20).map(row => `
    <div class="record-card">
      <div class="record-header">
        <div class="record-time">${row[0]}</div>
        <div class="record-status">${row[5] || 'Active'}</div>
      </div>
      <div class="record-details">
        <div class="record-item">
          <div class="record-item-label">WID</div>
          <div class="record-item-value">${row[2]}</div>
        </div>
        <div class="record-item">
          <div class="record-item-label">Location</div>
          <div class="record-item-value">${row[3]}</div>
        </div>
        ${row[4] ? `
        <div class="record-item">
          <div class="record-item-label">Floor</div>
          <div class="record-item-value">${row[4]}</div>
        </div>
        ` : ''}
        ${row[6] ? `
        <div class="record-item">
          <div class="record-item-label">Remark</div>
          <div class="record-item-value">${row[6]}</div>
        </div>
        ` : ''}
      </div>
    </div>
  `).join('');
}

function showToast(text, color) {
  msgEl.textContent = text;
  msgEl.style.background = color;
  msgEl.classList.add("show");
  setTimeout(() => msgEl.classList.remove("show"), 2000);
}

function debounce(func, wait) {
  let timeout;
  return function(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
}
</script>

</body>
</html>
